{% extends "base.html" %}

{% block title %}Admin — {{ settings.event_name }}{% endblock %}
{% block body_class %}text-slate-200{% endblock %}

{% block head %}
<style>
  input, select { font-family: inherit; }
</style>
{% endblock %}

{% block body %}
<div class="min-h-screen bg-midnight text-slate-200 admin-scrollable" hx-ext="json-enc">

  <!-- Header bar -->
  <div class="bg-gray-900 border-b border-slate-800 px-7 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3.5">
      <div id="status-dot" class="w-2 h-2 rounded-full {% if state.status.value == 'round-active' and not state.timer_paused %}bg-green-500 shadow-[0_0_8px_#22c55e]{% else %}bg-amber-500 shadow-[0_0_8px_#f59e0b]{% endif %}"></div>
      <span class="text-[15px] font-semibold text-slate-400 tracking-wide uppercase">
        Admin — Dosido
      </span>
    </div>
    <div class="text-[13px] text-slate-500">
      {{ settings.event_name }}
    </div>
  </div>

  <div class="px-7 py-6 pb-20 max-w-[1200px] mx-auto">

    <!-- Round Control -->
    <div class="bg-gray-900 border border-slate-800 rounded-xl p-6 mb-5">
      <div id="admin-round-control">
        {% include "partials/admin_round_control.html" %}
      </div>

      <div class="flex gap-3 items-center mt-5 ml-auto justify-end">
        <label class="text-xs text-slate-500 flex items-center gap-1.5">
          Duration
          <input type="number" id="round-duration" value="{{ settings.round_duration_minutes }}" min="1" max="30"
                 data-original="{{ settings.round_duration_minutes }}" oninput="checkSettingsChanged()"
                 class="input-dark rounded-md px-2.5 text-[13px] w-16 h-[30px]">
          <span class="text-slate-500">min</span>
        </label>
        <label class="text-xs text-slate-500 flex items-center gap-1.5">
          Rounds
          <select id="total-rounds" data-original="{{ state.round_number + state.rounds_remaining }}" onchange="checkSettingsChanged()"
                  class="input-dark rounded-md px-2.5 text-[13px] h-[30px]">
            {% for n in range(6, 16) %}
            <option value="{{ n }}" {% if n == state.round_number + state.rounds_remaining %}selected{% endif %}>{{ n }}</option>
            {% endfor %}
          </select>
        </label>
        <button id="save-settings-btn" onclick="saveSettings()" class="hidden bg-blue-500 text-white border-none rounded-md px-3.5 py-1.5 font-semibold text-xs cursor-pointer">Save</button>
        <span id="saved-indicator" class="hidden text-xs text-green-500">Saved!</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-0.5 mb-5" id="admin-tabs">
      <button onclick="switchTab('pool')" data-tab="pool"
              class="admin-tab admin-tab-active border rounded-lg px-[18px] py-2.5 font-semibold text-[13px] cursor-pointer">
        Attendee Pool ({{ counts.total }})
      </button>
      <button onclick="switchTab('pairings')" data-tab="pairings"
              class="admin-tab admin-tab-inactive border rounded-lg px-[18px] py-2.5 font-semibold text-[13px] cursor-pointer">
        Current Pairings
      </button>
      <button onclick="switchTab('signals')" data-tab="signals"
              class="admin-tab admin-tab-inactive border rounded-lg px-[18px] py-2.5 font-semibold text-[13px] cursor-pointer">
        Signals
      </button>
    </div>

    <!-- Pool Tab -->
    <div id="tab-pool" class="bg-gray-900 border border-slate-800 rounded-xl p-6">
      <div class="flex items-center mb-4">
        <input type="text" id="admin-filter" placeholder="Filter attendees..." oninput="filterAttendees(this.value)"
               class="input-dark rounded-lg px-3.5 py-2.5 text-sm w-[280px]">
        <button onclick="toggleWalkUp()" id="walkup-toggle-btn"
                class="ml-auto mr-3.5 bg-slate-800 text-slate-200 border border-gray-700 rounded-lg px-4 py-2.5 font-semibold text-[13px] cursor-pointer">
          + Add Walk-Up
        </button>
      </div>

      <div id="admin-pool">
        {% include "partials/admin_pool.html" %}
      </div>
    </div>

    <!-- Pairings Tab -->
    <div id="tab-pairings" class="hidden bg-gray-900 border border-slate-800 rounded-xl p-6">
      <div id="admin-pairings">
        {% include "partials/admin_pairings.html" %}
      </div>
    </div>

    <!-- Signals Tab -->
    <div id="tab-signals" class="hidden bg-gray-900 border border-slate-800 rounded-xl p-6">
      <div id="admin-signals">
        {% include "partials/admin_signals.html" %}
      </div>
    </div>

  </div>

  <!-- Walk-Up Modal -->
  <div id="walkup-modal" onclick="if(event.target===this)toggleWalkUp()"
       class="hidden fixed inset-0 z-[100] bg-black/60 backdrop-blur-[4px] items-center justify-center">
    <div class="bg-gray-900 border border-slate-800 rounded-2xl p-8 w-[520px] max-w-[90vw] shadow-[0_24px_48px_rgba(0,0,0,0.4)]">
      <div class="flex justify-between items-center mb-6">
        <div>
          <div class="text-lg font-bold text-slate-200">Add Walk-Up Attendee</div>
          <div class="text-[13px] text-slate-500 mt-0.5">Quick-entry for attendees not on the pre-registered list</div>
        </div>
        <button onclick="toggleWalkUp()" class="bg-transparent border-none text-slate-500 text-2xl cursor-pointer px-2 py-1 leading-none">&times;</button>
      </div>

      <form id="walkup-form" hx-post="/api/admin/walk-up" hx-swap="none" hx-on::after-request="this.reset(); toggleWalkUp();">
        <!-- Name -->
        <div class="mb-4">
          <label class="text-xs font-semibold text-slate-400 uppercase tracking-wide block mb-1.5">Name *</label>
          <input type="text" name="name" required id="walkup-name-input"
                 class="input-dark rounded-lg px-4 py-3 text-base w-full box-border"
                 placeholder="Full name">
        </div>

        <!-- Email -->
        <div class="mb-4">
          <label class="text-xs font-semibold text-slate-400 uppercase tracking-wide block mb-1.5">Email</label>
          <input type="email" name="email"
                 class="input-dark rounded-lg px-4 py-3 text-sm w-full box-border"
                 placeholder="email@example.com">
        </div>

        <!-- Two-column fields -->
        <div class="grid grid-cols-2 gap-3 mb-4">
          <div>
            <label class="text-xs font-semibold text-slate-400 uppercase tracking-wide block mb-1.5">Badge</label>
            <select name="badge_slug" class="input-dark rounded-lg px-3.5 text-sm w-full h-11 box-border">
              <option value="">No badge</option>
              {% for badge in walkup_badges %}
              <option value="{{ badge.slug }}">{{ badge.slug }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="text-xs font-semibold text-slate-400 uppercase tracking-wide block mb-1.5">Lane</label>
            <select name="lane" class="input-dark rounded-lg px-3.5 text-sm w-full h-11 box-border">
              <option value="idea">Idea-holder</option>
              <option value="joiner">Joiner</option>
              <option value="flexible" selected>Flexible</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-semibold text-slate-400 uppercase tracking-wide block mb-1.5">Primary Role</label>
            <select name="role" class="input-dark rounded-lg px-3.5 text-sm w-full h-11 box-border">
              <option value="engineering">Engineering</option>
              <option value="product">Product</option>
              <option value="gtm">GTM / Sales</option>
              <option value="science">Science</option>
              <option value="ops">Operations</option>
              <option value="policy">Policy</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-semibold text-slate-400 uppercase tracking-wide block mb-1.5">Role Needed</label>
            <select name="role_needed" class="input-dark rounded-lg px-3.5 text-sm w-full h-11 box-border">
              <option value="engineering">Engineering</option>
              <option value="product">Product</option>
              <option value="gtm">GTM / Sales</option>
              <option value="science">Science</option>
              <option value="ops">Operations</option>
              <option value="policy">Policy</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-semibold text-slate-400 uppercase tracking-wide block mb-1.5">Top Climate Area</label>
            <input type="text" name="top_climate_area" placeholder="e.g., energy"
                   class="input-dark rounded-lg px-3.5 text-sm w-full h-11 box-border">
          </div>
          <div>
            <label class="text-xs font-semibold text-slate-400 uppercase tracking-wide block mb-1.5">Commitment</label>
            <select name="commitment" class="input-dark rounded-lg px-3.5 text-sm w-full h-11 box-border">
              <option value="full-time">Full-time</option>
              <option value="part-time">Part-time</option>
              <option value="exploring" selected>Exploring</option>
            </select>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-2.5 justify-end pt-2 border-t border-slate-800">
          <button type="button" onclick="toggleWalkUp()"
                  class="bg-slate-800 text-slate-200 border border-gray-700 rounded-lg px-5 py-2.5 font-semibold text-sm cursor-pointer">
            Cancel
          </button>
          <button type="submit"
                  class="bg-green-500 text-midnight border-none rounded-lg px-6 py-2.5 font-semibold text-sm cursor-pointer">
            Add to Pool
          </button>
        </div>
      </form>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/timer.js"></script>
<script>
// Initialize timer if round is active
{% if state.timer_end %}
Timer.setEnd("{{ state.timer_end }}");
{% elif state.timer_paused and state.timer_remaining is not none %}
Timer.pause({{ state.timer_remaining }});
{% endif %}

const PARTIAL_BASE = "/{{ slug }}/admin/{{ admin_token }}/partial";

// Tab switching
function switchTab(tab) {
  document.querySelectorAll('[id^="tab-"]').forEach(function(el) {
    el.classList.add('hidden');
  });
  document.getElementById('tab-' + tab).classList.remove('hidden');
  document.querySelectorAll('.admin-tab').forEach(function(btn) {
    var isActive = btn.dataset.tab === tab;
    btn.classList.toggle('admin-tab-active', isActive);
    btn.classList.toggle('admin-tab-inactive', !isActive);
  });
}

// Walk-up modal toggle
function toggleWalkUp() {
  var modal = document.getElementById('walkup-modal');
  var isHidden = modal.classList.contains('hidden');
  if (isHidden) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(function() { document.getElementById('walkup-name-input').focus(); }, 50);
  } else {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    document.getElementById('walkup-form').reset();
  }
}
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && !document.getElementById('walkup-modal').classList.contains('hidden')) toggleWalkUp();
});

// Round control helpers (defined here so they survive partial swaps via innerHTML)
function confirmAdvance(e) {
  e.preventDefault();
  document.getElementById('advance-btn').classList.add('hidden');
  var confirm = document.getElementById('advance-confirm');
  confirm.classList.remove('hidden');
  confirm.classList.add('flex');
}
function cancelAdvance() {
  document.getElementById('advance-btn').classList.remove('hidden');
  var confirm = document.getElementById('advance-confirm');
  confirm.classList.add('hidden');
  confirm.classList.remove('flex');
}

// Swap override helper (defined here so it survives partial swaps via innerHTML)
function resolveSwapIds(form) {
  ['1', '2'].forEach(function(n) {
    var name = document.getElementById('swap-input-' + n).value;
    var opts = document.getElementById('swap-list-' + n).options;
    for (var i = 0; i < opts.length; i++) {
      if (opts[i].value === name) {
        document.getElementById('swap-id-' + n).value = opts[i].dataset.id;
        return;
      }
    }
  });
}

// Swap a single admin partial via fetch (avoids htmx.ajax silent request drops)
function swapPartial(path, targetId) {
  return fetch(PARTIAL_BASE + '/' + path + '?_=' + Date.now())
    .then(function(response) {
      if (!response.ok) {
        console.warn('[SSE] partial fetch failed:', path, response.status);
        return;
      }
      return response.text();
    })
    .then(function(html) {
      if (html == null) return;
      var element = document.getElementById(targetId);
      if (!element) {
        console.warn('[SSE] target element not found:', targetId);
        return;
      }
      element.innerHTML = html;
      htmx.process(element);
    })
    .catch(function(error) {
      console.warn('[SSE] partial fetch error:', path, error);
    });
}

// Refresh all admin partials (used by round_update and SSE reconnection)
function refreshAdminPartials() {
  return Promise.all([
    swapPartial('round-control', 'admin-round-control'),
    swapPartial('pairings', 'admin-pairings'),
    swapPartial('signals', 'admin-signals')
  ]);
}

// Round update: refresh round control + pairings, then set timer
document.body.addEventListener("sse:round_update", function(e) {
  const data = JSON.parse(e.detail.data);
  refreshAdminPartials().then(function() {
    if (data.timer_end) {
      Timer.setEnd(data.timer_end);
      // Auto-switch to pairings tab so admin sees the new round
      switchTab('pairings');
    } else if (data.undone) {
      Timer.clear();
    }
  });
});

// SSE reconnection: refresh all partials to catch any missed events
document.body.addEventListener("sse:reconnected", function() {
  refreshAdminPartials().then(function() {
    // Restore timer from refreshed round-control state
    var timerEl = document.getElementById('timer-display');
    if (timerEl && timerEl.dataset.timerEnd) {
      Timer.setEnd(timerEl.dataset.timerEnd);
    }
  });
});

// Timer update: refresh round control (pause/resume button) + update JS timer
document.body.addEventListener("sse:timer_update", function(e) {
  const data = JSON.parse(e.detail.data);
  swapPartial('round-control', 'admin-round-control').then(function() {
    if (data.action === "pause") {
      Timer.pause(data.timer_remaining);
    } else if (data.action === "resume") {
      Timer.resume(data.timer_end);
    }
  });
});

// Signal update: refresh signals tab
document.body.addEventListener("sse:signal_update", function(e) {
  swapPartial('signals', 'admin-signals');
});

// Check-in update: refresh pool + round control (active count in confirm dialog)
document.body.addEventListener("sse:checkin_update", function(e) {
  // Preserve scroll position of the attendee list
  var scrollable = document.querySelector('#admin-pool [data-pool-list]');
  var savedScroll = scrollable ? scrollable.scrollTop : 0;

  Promise.all([
    swapPartial('pool', 'admin-pool'),
    swapPartial('round-control', 'admin-round-control')
  ]).then(function() {
    // Restore scroll position
    var newScrollable = document.querySelector('#admin-pool [data-pool-list]');
    if (newScrollable) newScrollable.scrollTop = savedScroll;

    // Re-apply attendee filter after pool refresh
    var filter = document.getElementById('admin-filter');
    if (filter && filter.value) {
      filterAttendees(filter.value);
    }
  });
});

// Client-side attendee filter
function filterAttendees(query) {
  const rows = document.querySelectorAll('[data-attendee-name]');
  const q = query.toLowerCase().trim();
  rows.forEach(function(row) {
    row.classList.toggle('hidden', q && !row.dataset.attendeeName.includes(q));
  });
}

// Settings save with dirty detection
function checkSettingsChanged() {
  var dur = document.getElementById('round-duration');
  var tot = document.getElementById('total-rounds');
  var changed = dur.value !== dur.dataset.original || tot.value !== tot.dataset.original;
  document.getElementById('save-settings-btn').classList.toggle('hidden', !changed);
  document.getElementById('saved-indicator').classList.add('hidden');
}

function saveSettings() {
  var dur = document.getElementById('round-duration');
  var tot = document.getElementById('total-rounds');
  fetch('/api/admin/settings', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      round_duration_minutes: parseInt(dur.value),
      total_rounds: parseInt(tot.value)
    })
  }).then(function() {
    dur.dataset.original = dur.value;
    tot.dataset.original = tot.value;
    document.getElementById('save-settings-btn').classList.add('hidden');
    var indicator = document.getElementById('saved-indicator');
    indicator.classList.remove('hidden');
    setTimeout(function() { indicator.classList.add('hidden'); }, 3000);
    // Refresh round control to update "Round X of Y" display
    swapPartial('round-control', 'admin-round-control');
  });
}
</script>
{% endblock %}
