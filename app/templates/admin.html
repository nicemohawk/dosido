{% extends "base.html" %}

{% block title %}Admin — {{ settings.event_name }}{% endblock %}

{% block body %}
<div class="max-w-5xl mx-auto px-4 py-6" hx-ext="json-enc">

  <h1 class="text-2xl font-bold mb-1">Admin — Cofounder Matchmaking</h1>
  <p class="text-gray-500 text-sm mb-6">{{ settings.event_name }}</p>

  <!-- ROUND CONTROL -->
  <section class="bg-white rounded-lg shadow p-5 mb-6">
    <h2 class="text-lg font-semibold mb-1">Round Control</h2>
    <p class="text-gray-400 text-xs mb-4">Click "Start Next Round" when attendees are seated and ready. The solver runs in ~1 second.</p>

    <div id="admin-round-control">
      {% include "partials/admin_round_control.html" %}
    </div>

    <div class="flex gap-4 text-sm text-gray-600 items-center">
      <label>
        Round duration:
        <input type="number" value="{{ settings.round_duration_minutes }}" min="1" max="30"
               class="w-16 border rounded px-2 py-1 ml-1" id="round-duration"
               data-original="{{ settings.round_duration_minutes }}"
               oninput="checkSettingsChanged()"> min
      </label>
      <label>
        Total rounds:
        <input type="number" value="{{ state.round_number + state.rounds_remaining }}" min="1" max="20"
               class="w-16 border rounded px-2 py-1 ml-1" id="total-rounds"
               data-original="{{ state.round_number + state.rounds_remaining }}"
               oninput="checkSettingsChanged()">
      </label>
      <button id="save-settings-btn" class="text-blue-600 underline text-sm hidden"
        onclick="saveSettings()">Save</button>
      <span id="saved-indicator" class="text-green-600 text-sm transition-opacity duration-500 hidden">Saved!</span>
    </div>
  </section>

  <!-- ATTENDEE POOL -->
  <section class="bg-white rounded-lg shadow p-5 mb-6">
    <h2 class="text-lg font-semibold mb-1">Attendee Pool</h2>
    <p class="text-gray-400 text-xs mb-3">Check in attendees as they arrive. They'll be included in the next round.</p>

    <input type="text" placeholder="Filter attendees..."
           class="w-full border rounded px-3 py-2 mb-3 text-sm" id="admin-filter"
           oninput="filterAttendees(this.value)">

    <div id="admin-pool">
      {% include "partials/admin_pool.html" %}
    </div>
  </section>

  <!-- ADD WALK-UP -->
  <section class="bg-white rounded-lg shadow p-5 mb-6">
    <h2 class="text-lg font-semibold mb-1">Add Walk-Up Attendee</h2>
    <p class="text-gray-400 text-xs mb-3">For attendees not on the pre-registered list. Pick a badge from the reserve stack and select its slug below.</p>

    <details class="group">
      <summary class="cursor-pointer text-blue-600 font-medium text-sm group-open:mb-4">+ Add Walk-Up Attendee</summary>

      <form hx-post="/api/admin/walk-up" hx-swap="none" hx-on::after-request="this.reset()"
            class="grid grid-cols-2 gap-3 text-sm">
        <div class="col-span-2">
          <label class="block text-gray-600 mb-1">Name *</label>
          <input type="text" name="name" required class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-gray-600 mb-1">Email</label>
          <input type="email" name="email" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-gray-600 mb-1">Badge slug</label>
          <select name="badge_slug" class="w-full border rounded px-3 py-2">
            <option value="">No badge</option>
            {% for badge in walkup_badges %}
            <option value="{{ badge.slug }}">{{ badge.slug }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-gray-600 mb-1">Lane</label>
          <select name="lane" class="w-full border rounded px-3 py-2">
            <option value="idea">Idea-holder</option>
            <option value="joiner">Joiner</option>
            <option value="flexible" selected>Flexible</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-600 mb-1">Primary role</label>
          <select name="role" class="w-full border rounded px-3 py-2">
            <option value="engineering">Engineering</option>
            <option value="product">Product</option>
            <option value="gtm">GTM / Sales</option>
            <option value="science">Science</option>
            <option value="ops">Operations</option>
            <option value="policy">Policy</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-600 mb-1">Role needed</label>
          <select name="role_needed" class="w-full border rounded px-3 py-2">
            <option value="engineering">Engineering</option>
            <option value="product">Product</option>
            <option value="gtm">GTM / Sales</option>
            <option value="science">Science</option>
            <option value="ops">Operations</option>
            <option value="policy">Policy</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-600 mb-1">Top climate area</label>
          <input type="text" name="top_climate_area" placeholder="e.g., energy" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-gray-600 mb-1">Commitment</label>
          <select name="commitment" class="w-full border rounded px-3 py-2">
            <option value="full-time">Full-time</option>
            <option value="part-time">Part-time</option>
            <option value="exploring" selected>Exploring</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-600 mb-1">Working arrangement</label>
          <select name="arrangement" class="w-full border rounded px-3 py-2">
            <option value="remote-open" selected>Remote / Open</option>
            <option value="colocated">Colocated only</option>
          </select>
        </div>
        <div class="col-span-2">
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded font-medium hover:bg-blue-700">
            Add Walk-Up
          </button>
        </div>
      </form>
    </details>
  </section>

  <!-- CURRENT PAIRINGS + SWAP OVERRIDE -->
  <section class="bg-white rounded-lg shadow p-5 mb-6" id="admin-pairings">
    {% include "partials/admin_pairings.html" %}
  </section>

  <!-- SIGNAL STATS -->
  {% if signal_stats %}
  <section class="bg-white rounded-lg shadow p-5 mb-6">
    <h2 class="text-lg font-semibold mb-3">Signals</h2>
    <div class="text-sm text-gray-600 space-y-1">
      <p>Signals submitted this round: {{ signal_stats.submitted }} / {{ signal_stats.total_active }} attendees</p>
      <p>Total mutual matches (all rounds): {{ signal_stats.mutual_total }}</p>
    </div>
  </section>
  {% endif %}

</div>

{% endblock %}

{% block scripts %}
<script src="/static/js/timer.js"></script>
<script>
// Initialize timer if round is active
{% if state.timer_end %}
Timer.setEnd("{{ state.timer_end }}");
{% elif state.timer_paused and state.timer_remaining is not none %}
Timer.pause({{ state.timer_remaining }});
{% endif %}

const PARTIAL_BASE = "/{{ slug }}/admin/{{ admin_token }}/partial";

// Round update: refresh round control + pairings, then set timer
document.body.addEventListener("sse:round_update", function(e) {
  const data = JSON.parse(e.detail.data);
  Promise.all([
    htmx.ajax('GET', PARTIAL_BASE + '/round-control', {target: '#admin-round-control', swap: 'innerHTML'}),
    htmx.ajax('GET', PARTIAL_BASE + '/pairings', {target: '#admin-pairings', swap: 'innerHTML'})
  ]).then(function() {
    if (data.timer_end) {
      Timer.setEnd(data.timer_end);
    } else if (data.undone) {
      Timer.clear();
    }
  });
});

// Timer update: refresh round control (pause/resume button) + update JS timer
document.body.addEventListener("sse:timer_update", function(e) {
  const data = JSON.parse(e.detail.data);
  htmx.ajax('GET', PARTIAL_BASE + '/round-control', {target: '#admin-round-control', swap: 'innerHTML'})
    .then(function() {
      if (data.action === "pause") {
        Timer.pause(data.timer_remaining);
      } else if (data.action === "resume") {
        Timer.resume(data.timer_end);
      }
    });
});

// Check-in update: refresh pool + round control (active count in confirm dialog)
document.body.addEventListener("sse:checkin_update", function(e) {
  // Preserve scroll position of the attendee list
  var scrollable = document.querySelector('#admin-pool .overflow-y-auto');
  var savedScroll = scrollable ? scrollable.scrollTop : 0;

  Promise.all([
    htmx.ajax('GET', PARTIAL_BASE + '/pool', {target: '#admin-pool', swap: 'innerHTML'}),
    htmx.ajax('GET', PARTIAL_BASE + '/round-control', {target: '#admin-round-control', swap: 'innerHTML'})
  ]).then(function() {
    // Restore scroll position
    var newScrollable = document.querySelector('#admin-pool .overflow-y-auto');
    if (newScrollable) newScrollable.scrollTop = savedScroll;

    // Re-apply attendee filter after pool refresh
    var filter = document.getElementById('admin-filter');
    if (filter && filter.value) {
      filterAttendees(filter.value);
    }
  });
});

// Client-side attendee filter
function filterAttendees(query) {
  const rows = document.querySelectorAll('[data-attendee-name]');
  const q = query.toLowerCase().trim();
  rows.forEach(row => {
    row.style.display = !q || row.dataset.attendeeName.includes(q) ? '' : 'none';
  });
}

// Settings save with dirty detection
function checkSettingsChanged() {
  var dur = document.getElementById('round-duration');
  var tot = document.getElementById('total-rounds');
  var changed = dur.value !== dur.dataset.original || tot.value !== tot.dataset.original;
  document.getElementById('save-settings-btn').classList.toggle('hidden', !changed);
  document.getElementById('saved-indicator').classList.add('hidden');
}

function saveSettings() {
  var dur = document.getElementById('round-duration');
  var tot = document.getElementById('total-rounds');
  fetch('/api/admin/settings', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      round_duration_minutes: parseInt(dur.value),
      total_rounds: parseInt(tot.value)
    })
  }).then(function() {
    dur.dataset.original = dur.value;
    tot.dataset.original = tot.value;
    document.getElementById('save-settings-btn').classList.add('hidden');
    var indicator = document.getElementById('saved-indicator');
    indicator.classList.remove('hidden');
    indicator.style.opacity = '1';
    setTimeout(function() { indicator.style.opacity = '0'; }, 5000);
    setTimeout(function() { indicator.classList.add('hidden'); indicator.style.opacity = '1'; }, 5500);
  });
}
</script>
{% endblock %}
