{% extends "base.html" %}

{% block title %}Admin — {{ settings.event_name }}{% endblock %}
{% block body_class %}text-[#e2e8f0]{% endblock %}

{% block head %}
<style>
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  input, select { font-family: inherit; }
  a.profile-link { color: #93c5fd; text-decoration: none; }
  a.profile-link:hover { text-decoration: underline; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: #111827; }
  ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
</style>
{% endblock %}

{% block body %}
<div style="min-height: 100vh; background: #0a0f1a; color: #e2e8f0;" hx-ext="json-enc">

  <!-- Header bar -->
  <div style="background: #111827; border-bottom: 1px solid #1e293b; padding: 16px 28px; display: flex; align-items: center; justify-content: space-between;">
    <div style="display: flex; align-items: center; gap: 14px;">
      <div id="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: {% if state.status.value == 'round-active' and not state.timer_paused %}#22c55e{% else %}#f59e0b{% endif %}; box-shadow: 0 0 8px {% if state.status.value == 'round-active' and not state.timer_paused %}#22c55e{% else %}#f59e0b{% endif %};"></div>
      <span style="font-size: 15px; font-weight: 600; color: #94a3b8; letter-spacing: 0.05em; text-transform: uppercase;">
        Admin — Dosido
      </span>
    </div>
    <div style="font-size: 13px; color: #64748b;">
      {{ settings.event_name }}
    </div>
  </div>

  <div style="padding: 24px 28px 80px; max-width: 1200px; margin: 0 auto;">

    <!-- Round Control -->
    <div style="background: #111827; border: 1px solid #1e293b; border-radius: 12px; padding: 24px; margin-bottom: 20px;">
      <div id="admin-round-control">
        {% include "partials/admin_round_control.html" %}
      </div>

      <div style="display: flex; gap: 12px; align-items: center; margin-top: 20px; margin-left: auto; justify-content: flex-end;">
        <label style="font-size: 12px; color: #64748b; display: flex; align-items: center; gap: 6px;">
          Duration
          <input type="number" id="round-duration" value="{{ settings.round_duration_minutes }}" min="1" max="30"
                 data-original="{{ settings.round_duration_minutes }}" oninput="checkSettingsChanged()"
                 style="background: #1e293b; color: #e2e8f0; border: 1px solid #374151; border-radius: 6px; padding: 0 10px; font-size: 13px; width: 64px; height: 30px;">
          <span style="color: #64748b;">min</span>
        </label>
        <label style="font-size: 12px; color: #64748b; display: flex; align-items: center; gap: 6px;">
          Rounds
          <select id="total-rounds" data-original="{{ state.round_number + state.rounds_remaining }}" onchange="checkSettingsChanged()"
                  style="background: #1e293b; color: #e2e8f0; border: 1px solid #374151; border-radius: 6px; padding: 0 10px; font-size: 13px; height: 30px;">
            {% for n in range(6, 16) %}
            <option value="{{ n }}" {% if n == state.round_number + state.rounds_remaining %}selected{% endif %}>{{ n }}</option>
            {% endfor %}
          </select>
        </label>
        <button id="save-settings-btn" onclick="saveSettings()" style="display: none; background: #3b82f6; color: white; border: none; border-radius: 6px; padding: 6px 14px; font-weight: 600; font-size: 12px; cursor: pointer;">Save</button>
        <span id="saved-indicator" style="display: none; font-size: 12px; color: #22c55e;">Saved!</span>
      </div>
    </div>

    <!-- Tabs -->
    <div style="display: flex; gap: 2px; margin-bottom: 20px;" id="admin-tabs">
      <button onclick="switchTab('pool')" data-tab="pool" class="admin-tab admin-tab-active"
              style="background: #1e293b; color: #e2e8f0; border: 1px solid #374151; border-radius: 8px; padding: 10px 18px; font-weight: 600; font-size: 13px; cursor: pointer;">
        Attendee Pool ({{ counts.total }})
      </button>
      <button onclick="switchTab('pairings')" data-tab="pairings" class="admin-tab"
              style="background: transparent; color: #64748b; border: 1px solid transparent; border-radius: 8px; padding: 10px 18px; font-weight: 600; font-size: 13px; cursor: pointer;">
        Current Pairings
      </button>
      <button onclick="switchTab('signals')" data-tab="signals" class="admin-tab"
              style="background: transparent; color: #64748b; border: 1px solid transparent; border-radius: 8px; padding: 10px 18px; font-weight: 600; font-size: 13px; cursor: pointer;">
        Signals
      </button>
    </div>

    <!-- Pool Tab -->
    <div id="tab-pool" style="background: #111827; border: 1px solid #1e293b; border-radius: 12px; padding: 24px;">
      <div style="display: flex; align-items: center; margin-bottom: 16px;">
        <input type="text" id="admin-filter" placeholder="Filter attendees..." oninput="filterAttendees(this.value)"
               style="background: #0a0f1a; color: #e2e8f0; border: 1px solid #374151; border-radius: 8px; padding: 10px 14px; font-size: 14px; width: 280px; outline: none;">
        <button onclick="toggleWalkUp()" id="walkup-toggle-btn"
                style="margin-left: auto; margin-right: 14px; background: #1e293b; color: #e2e8f0; border: 1px solid #374151; border-radius: 8px; padding: 10px 16px; font-weight: 600; font-size: 13px; cursor: pointer;">
          + Add Walk-Up
        </button>
      </div>

      <div id="admin-pool">
        {% include "partials/admin_pool.html" %}
      </div>
    </div>

    <!-- Pairings Tab -->
    <div id="tab-pairings" style="display: none; background: #111827; border: 1px solid #1e293b; border-radius: 12px; padding: 24px;">
      <div id="admin-pairings">
        {% include "partials/admin_pairings.html" %}
      </div>
    </div>

    <!-- Signals Tab -->
    <div id="tab-signals" style="display: none; background: #111827; border: 1px solid #1e293b; border-radius: 12px; padding: 24px;">
      <div id="admin-signals">
        {% include "partials/admin_signals.html" %}
      </div>
    </div>

  </div>

  <!-- Walk-Up Modal -->
  <div id="walkup-modal" onclick="if(event.target===this)toggleWalkUp()"
       style="display: none; position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center;">
    <div style="background: #111827; border: 1px solid #1e293b; border-radius: 16px; padding: 32px; width: 520px; max-width: 90vw; box-shadow: 0 24px 48px rgba(0,0,0,0.4);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
          <div style="font-size: 18px; font-weight: 700; color: #e2e8f0;">Add Walk-Up Attendee</div>
          <div style="font-size: 13px; color: #64748b; margin-top: 2px;">Quick-entry for attendees not on the pre-registered list</div>
        </div>
        <button onclick="toggleWalkUp()" style="background: none; border: none; color: #64748b; font-size: 24px; cursor: pointer; padding: 4px 8px; line-height: 1;">&times;</button>
      </div>

      <form id="walkup-form" hx-post="/api/admin/walk-up" hx-swap="none" hx-on::after-request="this.reset(); toggleWalkUp();">
        <!-- Name — full width, large, autofocused -->
        <div style="margin-bottom: 16px;">
          <label style="font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 6px;">Name *</label>
          <input type="text" name="name" required id="walkup-name-input"
                 style="background: #0a0f1a; color: #e2e8f0; border: 1px solid #374151; border-radius: 8px; padding: 12px 16px; font-size: 16px; width: 100%; outline: none; box-sizing: border-box;"
                 placeholder="Full name">
        </div>

        <!-- Email — full width -->
        <div style="margin-bottom: 16px;">
          <label style="font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 6px;">Email</label>
          <input type="email" name="email"
                 style="background: #0a0f1a; color: #e2e8f0; border: 1px solid #374151; border-radius: 8px; padding: 12px 16px; font-size: 14px; width: 100%; outline: none; box-sizing: border-box;"
                 placeholder="email@example.com">
        </div>

        <!-- Two-column fields -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
          <div>
            <label style="font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 6px;">Badge</label>
            <select name="badge_slug"
                    style="background: #0a0f1a; color: #e2e8f0; border: 1px solid #374151; border-radius: 8px; padding: 0 14px; font-size: 14px; width: 100%; height: 44px; box-sizing: border-box;">
              <option value="">No badge</option>
              {% for badge in walkup_badges %}
              <option value="{{ badge.slug }}">{{ badge.slug }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label style="font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 6px;">Lane</label>
            <select name="lane"
                    style="background: #0a0f1a; color: #e2e8f0; border: 1px solid #374151; border-radius: 8px; padding: 0 14px; font-size: 14px; width: 100%; height: 44px; box-sizing: border-box;">
              <option value="idea">Idea-holder</option>
              <option value="joiner">Joiner</option>
              <option value="flexible" selected>Flexible</option>
            </select>
          </div>
          <div>
            <label style="font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 6px;">Primary Role</label>
            <select name="role"
                    style="background: #0a0f1a; color: #e2e8f0; border: 1px solid #374151; border-radius: 8px; padding: 0 14px; font-size: 14px; width: 100%; height: 44px; box-sizing: border-box;">
              <option value="engineering">Engineering</option>
              <option value="product">Product</option>
              <option value="gtm">GTM / Sales</option>
              <option value="science">Science</option>
              <option value="ops">Operations</option>
              <option value="policy">Policy</option>
            </select>
          </div>
          <div>
            <label style="font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 6px;">Role Needed</label>
            <select name="role_needed"
                    style="background: #0a0f1a; color: #e2e8f0; border: 1px solid #374151; border-radius: 8px; padding: 0 14px; font-size: 14px; width: 100%; height: 44px; box-sizing: border-box;">
              <option value="engineering">Engineering</option>
              <option value="product">Product</option>
              <option value="gtm">GTM / Sales</option>
              <option value="science">Science</option>
              <option value="ops">Operations</option>
              <option value="policy">Policy</option>
            </select>
          </div>
          <div>
            <label style="font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 6px;">Top Climate Area</label>
            <input type="text" name="top_climate_area" placeholder="e.g., energy"
                   style="background: #0a0f1a; color: #e2e8f0; border: 1px solid #374151; border-radius: 8px; padding: 0 14px; font-size: 14px; width: 100%; height: 44px; outline: none; box-sizing: border-box;">
          </div>
          <div>
            <label style="font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 6px;">Commitment</label>
            <select name="commitment"
                    style="background: #0a0f1a; color: #e2e8f0; border: 1px solid #374151; border-radius: 8px; padding: 0 14px; font-size: 14px; width: 100%; height: 44px; box-sizing: border-box;">
              <option value="full-time">Full-time</option>
              <option value="part-time">Part-time</option>
              <option value="exploring" selected>Exploring</option>
            </select>
          </div>
        </div>

        <!-- Actions -->
        <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 8px; border-top: 1px solid #1e293b;">
          <button type="button" onclick="toggleWalkUp()"
                  style="background: #1e293b; color: #e2e8f0; border: 1px solid #374151; border-radius: 8px; padding: 10px 20px; font-weight: 600; font-size: 14px; cursor: pointer;">
            Cancel
          </button>
          <button type="submit"
                  style="background: #22c55e; color: #0a0f1a; border: none; border-radius: 8px; padding: 10px 24px; font-weight: 600; font-size: 14px; cursor: pointer;">
            Add to Pool
          </button>
        </div>
      </form>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/timer.js"></script>
<script>
// Initialize timer if round is active
{% if state.timer_end %}
Timer.setEnd("{{ state.timer_end }}");
{% elif state.timer_paused and state.timer_remaining is not none %}
Timer.pause({{ state.timer_remaining }});
{% endif %}

const PARTIAL_BASE = "/{{ slug }}/admin/{{ admin_token }}/partial";

// Tab switching
function switchTab(tab) {
  document.querySelectorAll('[id^="tab-"]').forEach(function(el) { el.style.display = 'none'; });
  document.getElementById('tab-' + tab).style.display = '';
  document.querySelectorAll('.admin-tab').forEach(function(btn) {
    var isActive = btn.dataset.tab === tab;
    btn.style.background = isActive ? '#1e293b' : 'transparent';
    btn.style.color = isActive ? '#e2e8f0' : '#64748b';
    btn.style.borderColor = isActive ? '#374151' : 'transparent';
  });
}

// Walk-up modal toggle
function toggleWalkUp() {
  var modal = document.getElementById('walkup-modal');
  var isHidden = modal.style.display === 'none';
  modal.style.display = isHidden ? 'flex' : 'none';
  if (isHidden) {
    setTimeout(function() { document.getElementById('walkup-name-input').focus(); }, 50);
  } else {
    document.getElementById('walkup-form').reset();
  }
}
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.getElementById('walkup-modal').style.display === 'flex') toggleWalkUp();
});

// Swap a single admin partial via fetch (avoids htmx.ajax silent request drops)
function swapPartial(path, targetId) {
  return fetch(PARTIAL_BASE + '/' + path + '?_=' + Date.now())
    .then(function(response) {
      if (!response.ok) {
        console.warn('[SSE] partial fetch failed:', path, response.status);
        return;
      }
      return response.text();
    })
    .then(function(html) {
      if (html == null) return;
      var element = document.getElementById(targetId);
      if (element) {
        element.innerHTML = html;
        htmx.process(element);
      }
    })
    .catch(function(error) {
      console.warn('[SSE] partial fetch error:', path, error);
    });
}

// Refresh all admin partials (used by round_update and SSE reconnection)
function refreshAdminPartials() {
  return Promise.all([
    swapPartial('round-control', 'admin-round-control'),
    swapPartial('pairings', 'admin-pairings'),
    swapPartial('signals', 'admin-signals')
  ]);
}

// Resolve swap form inputs to attendee IDs (used in pairings partial)
function resolveSwapIds(form) {
  ['1', '2'].forEach(function(n) {
    var name = document.getElementById('swap-input-' + n).value;
    var opts = document.getElementById('swap-list-' + n).options;
    for (var i = 0; i < opts.length; i++) {
      if (opts[i].value === name) {
        document.getElementById('swap-id-' + n).value = opts[i].dataset.id;
        return;
      }
    }
  });
}

// Round advance confirmation (used in round control partial)
function confirmAdvance(e) {
  e.preventDefault();
  document.getElementById('advance-btn').style.display = 'none';
  document.getElementById('advance-confirm').style.display = 'flex';
}
function cancelAdvance() {
  document.getElementById('advance-btn').style.display = '';
  document.getElementById('advance-confirm').style.display = 'none';
}

// Round update: refresh round control + pairings, then set timer
document.body.addEventListener("sse:round_update", function(e) {
  const data = JSON.parse(e.detail.data);
  refreshAdminPartials().then(function() {
    if (data.timer_end) {
      Timer.setEnd(data.timer_end);
      // Auto-switch to pairings tab so admin sees the new round
      switchTab('pairings');
    } else if (data.undone) {
      Timer.clear();
    }
  });
});

// SSE reconnection: refresh all partials to catch any missed events
document.body.addEventListener("sse:reconnected", function() {
  refreshAdminPartials().then(function() {
    // Restore timer from refreshed round-control state
    var timerEl = document.getElementById('timer-display');
    if (timerEl && timerEl.dataset.timerEnd) {
      Timer.setEnd(timerEl.dataset.timerEnd);
    }
  });
});

// Timer update: refresh round control (pause/resume button) + update JS timer
document.body.addEventListener("sse:timer_update", function(e) {
  const data = JSON.parse(e.detail.data);
  swapPartial('round-control', 'admin-round-control').then(function() {
    if (data.action === "pause") {
      Timer.pause(data.timer_remaining);
    } else if (data.action === "resume") {
      Timer.resume(data.timer_end);
    }
  });
});

// Signal update: refresh signals tab
document.body.addEventListener("sse:signal_update", function(e) {
  swapPartial('signals', 'admin-signals');
});

// Check-in update: refresh pool + round control (active count in confirm dialog)
document.body.addEventListener("sse:checkin_update", function(e) {
  // Preserve scroll position of the attendee list
  var scrollable = document.querySelector('#admin-pool [data-pool-list]');
  var savedScroll = scrollable ? scrollable.scrollTop : 0;

  Promise.all([
    swapPartial('pool', 'admin-pool'),
    swapPartial('round-control', 'admin-round-control')
  ]).then(function() {
    // Restore scroll position
    var newScrollable = document.querySelector('#admin-pool [data-pool-list]');
    if (newScrollable) newScrollable.scrollTop = savedScroll;

    // Re-apply attendee filter after pool refresh
    var filter = document.getElementById('admin-filter');
    if (filter && filter.value) {
      filterAttendees(filter.value);
    }
  });
});

// Client-side attendee filter
function filterAttendees(query) {
  const rows = document.querySelectorAll('[data-attendee-name]');
  const q = query.toLowerCase().trim();
  rows.forEach(row => {
    row.style.display = !q || row.dataset.attendeeName.includes(q) ? 'flex' : 'none';
  });
}

// Settings save with dirty detection
function checkSettingsChanged() {
  var dur = document.getElementById('round-duration');
  var tot = document.getElementById('total-rounds');
  var changed = dur.value !== dur.dataset.original || tot.value !== tot.dataset.original;
  document.getElementById('save-settings-btn').style.display = changed ? '' : 'none';
  document.getElementById('saved-indicator').style.display = 'none';
}

function saveSettings() {
  var dur = document.getElementById('round-duration');
  var tot = document.getElementById('total-rounds');
  fetch('/api/admin/settings', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      round_duration_minutes: parseInt(dur.value),
      total_rounds: parseInt(tot.value)
    })
  }).then(function() {
    dur.dataset.original = dur.value;
    tot.dataset.original = tot.value;
    document.getElementById('save-settings-btn').style.display = 'none';
    var indicator = document.getElementById('saved-indicator');
    indicator.style.display = '';
    setTimeout(function() { indicator.style.display = 'none'; }, 3000);
    // Refresh round control to update "Round X of Y" display
    swapPartial('round-control', 'admin-round-control');
  });
}
</script>
{% endblock %}
