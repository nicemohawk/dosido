{% extends "base.html" %}

{% block title %}{{ settings.event_name }} â€” Screen{% endblock %}
{% block body_class %}text-slate-200{% endblock %}

{% block body %}
<div class="bg-midnight py-7 px-10 h-screen flex flex-col">

  <!-- Header -->
  <div class="flex justify-between items-center mb-5 flex-shrink-0">
    <div>
      <div class="text-xs font-semibold text-slate-600 tracking-[0.1em] uppercase mb-0.5">
        {{ settings.event_name }}
      </div>
      {% if state.round_number > 0 %}
      <div class="text-[26px] font-bold">
        Round {{ state.round_number }} <span class="text-slate-600 font-normal">of {{ state.round_number + state.rounds_remaining }}</span>
      </div>
      {% else %}
      <div class="text-[26px] font-bold">Waiting for Round 1</div>
      {% endif %}
    </div>
    <div class="flex items-center gap-5">
      {% if pairings %}
      <div class="text-[13px] text-slate-500">
        {{ pairings|length }} tables &middot; {{ counts.active }} attendees
      </div>
      {% endif %}
      <span id="timer-display" class="font-mono text-[56px] font-bold">--:--</span>
    </div>
  </div>

  <!-- Pairings grid or check-in board -->
  <div class="flex-1 min-h-0">
    {% if state.round_number > 0 and pairings %}
      {% set count = pairings|length %}
      {% if count <= 10 %}
        {% set cols = 2 %}
        {% set card_pad = "10px 16px" %}
        {% set card_gap = "8px" %}
        {% set grid_gap = "8px" %}
        {% set tbl_size = "28px" %}
        {% set tbl_min = "40px" %}
        {% set div_h = "36px" %}
        {% set name_size = "16px" %}
      {% elif count <= 15 %}
        {% set cols = 3 %}
        {% set card_pad = "8px 14px" %}
        {% set card_gap = "10px" %}
        {% set grid_gap = "6px" %}
        {% set tbl_size = "24px" %}
        {% set tbl_min = "36px" %}
        {% set div_h = "32px" %}
        {% set name_size = "14px" %}
      {% elif count <= 20 %}
        {% set cols = 4 %}
        {% set card_pad = "6px 10px" %}
        {% set card_gap = "10px" %}
        {% set grid_gap = "5px" %}
        {% set tbl_size = "20px" %}
        {% set tbl_min = "30px" %}
        {% set div_h = "28px" %}
        {% set name_size = "12px" %}
      {% elif count <= 25 %}
        {% set cols = 5 %}
        {% set card_pad = "6px 10px" %}
        {% set card_gap = "10px" %}
        {% set grid_gap = "5px" %}
        {% set tbl_size = "20px" %}
        {% set tbl_min = "30px" %}
        {% set div_h = "28px" %}
        {% set name_size = "12px" %}
      {% else %}
        {% set cols = 6 %}
        {% set card_pad = "6px 10px" %}
        {% set card_gap = "10px" %}
        {% set grid_gap = "5px" %}
        {% set tbl_size = "20px" %}
        {% set tbl_min = "30px" %}
        {% set div_h = "28px" %}
        {% set name_size = "12px" %}
      {% endif %}

      <div id="pairings-grid" class="grid content-start overflow-hidden" style="grid-template-columns: repeat({{ cols }}, 1fr); gap: {{ grid_gap }};">
        {% for p in pairings %}
        <div class="bg-gray-900 border border-slate-800 rounded-[7px] flex items-center" style="padding: {{ card_pad }}; gap: {{ card_gap }};"
             data-pairing-row data-pairing-names="{{ p.name_a }} {{ p.name_b }}">
          <div class="font-mono font-extrabold text-blue-500 text-center leading-none" style="font-size: {{ tbl_size }}; min-width: {{ tbl_min }};">
            {{ p.table_number }}
          </div>
          <div class="w-0.5 bg-[#1e3a5f] rounded-sm flex-shrink-0" style="height: {{ div_h }};"></div>
          <div class="flex-1 min-w-0">
            <div class="font-semibold truncate leading-[1.4]" style="font-size: {{ name_size }};">{{ p.name_a }}</div>
            <div class="font-medium text-slate-400 truncate leading-[1.4]" style="font-size: {{ name_size }};">{{ p.name_b }}</div>
          </div>
        </div>
        {% endfor %}
      </div>

      {% if pit_stop_info %}
      <div class="mt-1.5 flex-shrink-0 bg-pit-stop border border-pit-stop-border rounded-[7px] py-2 px-3.5 flex items-center gap-2.5">
        <span class="text-sm">&#9749;</span>
        <span class="text-[13px] text-amber-500 font-medium">Pit Stop: {{ pit_stop_info.name }}</span>
      </div>
      {% endif %}
    {% else %}
      <div id="main-content">
        {% include "partials/checkin_board.html" %}
      </div>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/timer.js"></script>
<script>
{% if state.timer_end %}
Timer.setEnd("{{ state.timer_end }}");
{% elif state.timer_paused and state.timer_remaining is not none %}
Timer.pause({{ state.timer_remaining }});
{% endif %}

document.body.addEventListener("sse:round_update", function(e) {
  const data = JSON.parse(e.detail.data);
  Timer.setEnd(data.timer_end);
  location.reload();
});

document.body.addEventListener("sse:timer_update", function(e) {
  const data = JSON.parse(e.detail.data);
  if (data.action === "pause") Timer.pause(data.timer_remaining);
  else if (data.action === "resume") Timer.resume(data.timer_end);
});

document.body.addEventListener("sse:checkin_update", function(e) {
  if (document.getElementById("checkin-board")) location.reload();
});

// Reload on SSE reconnection to catch any missed events
document.body.addEventListener("sse:reconnected", function() {
  location.reload();
});
</script>
{% endblock %}
